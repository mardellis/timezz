<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>TimeZZ Timer</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0; 
            padding: 20px; 
            background: #f8f9fa;
        }
        .timer-popup {
            text-align: center;
        }
        .btn {
            background: #0079bf;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin: 8px;
        }
        .btn:hover {
            background: #005a8b;
        }
        .btn.stop {
            background: #d63031;
        }
        .timer-display {
            font-size: 24px;
            font-weight: bold;
            color: #2d3436;
            margin: 16px 0;
        }
        .task-name {
            font-size: 16px;
            color: #636e72;
            margin-bottom: 16px;
        }
    </style>
    <script src="https://p.trellocdn.com/power-up.min.js"></script>
</head>
<body>
    <div class="timer-popup">
        <div id="content">
            <div class="task-name" id="taskName">Loading...</div>
            <div class="timer-display" id="timerDisplay">00:00:00</div>
            <button class="btn" id="actionBtn" onclick="toggleTimer()">Start Timer</button>
            <button class="btn" onclick="openDashboard()">Open Dashboard</button>
        </div>
    </div>

    <script>
        const t = TrelloPowerUp.iframe();
        let timerInterval;
        let startTime;
        
        // Initialize
        t.ready().then(() => {
            loadCardInfo();
            checkTimerStatus();
        });

        async function loadCardInfo() {
            const card = await t.card('name');
            document.getElementById('taskName').textContent = card.name;
        }

        async function checkTimerStatus() {
            const timer = await t.get('card', 'shared', 'timer');
            const actionBtn = document.getElementById('actionBtn');
            
            if (timer && timer.active) {
                actionBtn.textContent = 'Stop Timer';
                actionBtn.className = 'btn stop';
                startTime = new Date(timer.startTime);
                startTimerDisplay();
            } else {
                actionBtn.textContent = 'Start Timer';
                actionBtn.className = 'btn';
                stopTimerDisplay();
            }
        }

        function startTimerDisplay() {
            if (timerInterval) clearInterval(timerInterval);
            
            timerInterval = setInterval(() => {
                const elapsed = Math.floor((new Date() - startTime) / 1000);
                updateTimerDisplay(elapsed);
            }, 1000);
        }

        function stopTimerDisplay() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            updateTimerDisplay(0);
        }

        function updateTimerDisplay(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            
            const display = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            document.getElementById('timerDisplay').textContent = display;
        }

        async function toggleTimer() {
            const card = await t.card('id', 'name');
            const timer = await t.get('card', 'shared', 'timer');
            
            if (timer && timer.active) {
                // Stop timer
                await stopTimer(card, timer);
            } else {
                // Start timer
                await startTimer(card);
            }
            
            checkTimerStatus();
        }

        async function startTimer(card) {
            const timerData = {
                active: true,
                startTime: new Date().toISOString(),
                cardId: card.id,
                cardName: card.name
            };
            
            // Save to Trello
            await t.set('card', 'shared', 'timer', timerData);
            
            // Send to TimeZZ backend
            try {
                const response = await fetch('https://timezz-backend.onrender.com/api/v1/time/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('timezz_auth_token') || 'demo_token'}`
                    },
                    body: JSON.stringify({
                        card_id: card.id,
                        card_name: card.name,
                        board_id: await getBoardId()
                    })
                });
                
                if (response.ok) {
                    console.log('Timer started in TimeZZ');
                }
            } catch (error) {
                console.error('Failed to sync with TimeZZ:', error);
            }
        }

        async function stopTimer(card, timer) {
            const duration = (new Date() - new Date(timer.startTime)) / 1000;
            
            // Clear timer data
            await t.remove('card', 'shared', 'timer');
            
            // Send to TimeZZ backend
            try {
                const response = await fetch('https://timezz-backend.onrender.com/api/v1/time/stop', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('timezz_auth_token') || 'demo_token'}`
                    }
                });
                
                if (response.ok) {
                    console.log('Timer stopped in TimeZZ');
                }
            } catch (error) {
                console.error('Failed to sync with TimeZZ:', error);
            }
        }

        async function getBoardId() {
            const board = await t.board('id');
            return board.id;
        }

        function openDashboard() {
            // Open TimeZZ dashboard in new window
            window.open('http://localhost:3000', '_blank');
        }
    </script>
</body>
</html>