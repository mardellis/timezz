<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Connect TimeZZ</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0; 
            padding: 20px; 
            background: #f8f9fa;
        }
        .auth-form {
            max-width: 350px;
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .logo {
            text-align: center;
            margin-bottom: 20px;
        }
        .logo h2 {
            color: #0079bf;
            margin: 0;
            font-size: 24px;
        }
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 25px;
            font-size: 14px;
        }
        input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 14px;
        }
        input:focus {
            outline: none;
            border-color: #0079bf;
            box-shadow: 0 0 0 2px rgba(0, 121, 191, 0.2);
        }
        .btn {
            background: #0079bf;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            width: 100%;
            font-size: 14px;
            font-weight: 500;
        }
        .btn:hover {
            background: #005a8b;
        }
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .demo-btn {
            background: #6c757d;
            margin-top: 10px;
        }
        .demo-btn:hover {
            background: #545b62;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            display: none;
            font-size: 13px;
        }
        .success {
            background: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            display: none;
            font-size: 13px;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            padding: 12px;
            border-radius: 4px;
            margin: 15px 0;
            font-size: 13px;
            line-height: 1.4;
        }
        .loading {
            display: none;
            text-align: center;
            color: #666;
            margin: 10px 0;
        }
    </style>
    <script src="https://p.trellocdn.com/power-up.min.js"></script>
</head>
<body>
    <div class="auth-form">
        <div class="logo">
            <h2>⏱️ TimeZZ</h2>
        </div>
        <div class="subtitle">Connect your time tracking</div>

        <div class="info">
            <strong>Quick Setup:</strong> Just enter your email to get started. TimeZZ will automatically detect your Trello account information.
        </div>

        <div id="errorMessage" class="error"></div>
        <div id="successMessage" class="success"></div>
        <div id="loadingMessage" class="loading">Connecting...</div>

        <form id="authForm" onsubmit="authenticate(event)">
            <input 
                type="email" 
                id="email" 
                placeholder="Enter your email address" 
                required
                autocomplete="email"
            >
            
            <button type="submit" class="btn" id="connectBtn">
                Connect TimeZZ
            </button>
            
            <button type="button" class="btn demo-btn" onclick="useDemoMode()">
                Try Demo Mode
            </button>
        </form>

        <div style="text-align: center; margin-top: 15px; font-size: 12px; color: #999;">
            Your data is secure and private
        </div>
    </div>

    <script>
        const t = TrelloPowerUp.iframe();
        let trelloUser = null;

        // Get Trello user info when page loads
        t.ready().then(async () => {
            try {
                // Get current Trello user information
                trelloUser = await t.member('id', 'fullName', 'username');
                console.log('Trello user detected:', trelloUser);
            } catch (error) {
                console.log('Could not get Trello user info:', error);
            }
        });

        async function authenticate(event) {
            event.preventDefault();
            
            const email = document.getElementById('email').value;
            const connectBtn = document.getElementById('connectBtn');
            const loadingMessage = document.getElementById('loadingMessage');
            const errorMessage = document.getElementById('errorMessage');
            const successMessage = document.getElementById('successMessage');
            
            // Reset messages
            hideMessages();
            
            // Show loading
            connectBtn.disabled = true;
            connectBtn.textContent = 'Connecting...';
            loadingMessage.style.display = 'block';
            
            try {
                // Use Trello user info if available, otherwise generate ID
                const userId = trelloUser?.id || 'user_' + Date.now();
                const userName = trelloUser?.fullName || email.split('@')[0];
                const username = trelloUser?.username || email.split('@')[0];
                
                console.log('Attempting authentication with:', { email, userId, userName });
                
               // Line 49 - REPLACE localhost with your domain
                    const response = await fetch('https://timezz-backend.onrender.com/api/v1/auth/login', {
                    headers: { 
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        trello_user_id: userId,
                        trello_token: 'temp_token_' + Date.now(),
                        name: userName,
                        email: email
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log('Authentication successful:', data);
                    
                    // Save authentication token
                    await t.set('member', 'private', 'timezz_auth_token', data.access_token);
                    await t.set('member', 'private', 'timezz_user_info', {
                        id: data.user.id,
                        email: data.user.email,
                        name: data.user.name
                    });
                    
                    // Show success
                    successMessage.textContent = 'Successfully connected to TimeZZ!';
                    successMessage.style.display = 'block';
                    
                    // Close popup after a short delay
                    setTimeout(() => {
                        t.closePopup();
                    }, 1500);
                    
                } else {
                    throw new Error(`Authentication failed: ${response.status}`);
                }
                
            } catch (error) {
                console.error('Authentication error:', error);
                
                // Fall back to demo mode
                console.log('Falling back to demo mode');
                await setupDemoMode(email);
                
                successMessage.textContent = 'Connected in Demo Mode - full features available!';
                successMessage.style.display = 'block';
                
                setTimeout(() => {
                    t.closePopup();
                }, 1500);
                
            } finally {
                // Reset button
                connectBtn.disabled = false;
                connectBtn.textContent = 'Connect TimeZZ';
                loadingMessage.style.display = 'none';
            }
        }

        async function useDemoMode() {
            const email = document.getElementById('email').value || 'demo@example.com';
            await setupDemoMode(email);
            
            const successMessage = document.getElementById('successMessage');
            successMessage.textContent = 'Demo mode activated! Try all TimeZZ features.';
            successMessage.style.display = 'block';
            
            setTimeout(() => {
                t.closePopup();
            }, 1500);
        }

        async function setupDemoMode(email) {
            const demoUserId = 'demo_' + Date.now();
            const demoToken = 'demo_token_' + Date.now();
            
            // Save demo credentials
            await t.set('member', 'private', 'timezz_auth_token', demoToken);
            await t.set('member', 'private', 'timezz_user_info', {
                id: demoUserId,
                email: email,
                name: email.split('@')[0],
                demo_mode: true
            });
            
            console.log('Demo mode setup complete');
        }

        function hideMessages() {
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('successMessage').style.display = 'none';
            document.getElementById('loadingMessage').style.display = 'none';
        }

        function showError(message) {
            const errorMessage = document.getElementById('errorMessage');
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
        }
    </script>
</body>
</html>