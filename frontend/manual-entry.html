<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Add Time Entry - TimeZZ</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0; 
            padding: 20px; 
            background: #f8f9fa;
        }
        .manual-entry-popup {
            max-width: 400px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #2d3436;
        }
        input, textarea, select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            box-sizing: border-box;
        }
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #0079bf;
            box-shadow: 0 0 0 2px rgba(0,121,191,0.2);
        }
        .time-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .btn {
            background: #0079bf;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            width: 100%;
            margin: 8px 0;
        }
        .btn:hover {
            background: #005a8b;
        }
        .btn.secondary {
            background: #6c757d;
        }
        .card-info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #0079bf;
        }
        .card-name {
            font-weight: 600;
            color: #0079bf;
            margin-bottom: 5px;
        }
        .board-name {
            font-size: 0.9rem;
            color: #636e72;
        }
        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: none;
        }
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: none;
        }
        .preset-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 15px;
        }
        .preset-btn {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            text-align: center;
            transition: background 0.2s;
        }
        .preset-btn:hover {
            background: #e9ecef;
        }
        .preset-btn.active {
            background: #0079bf;
            color: white;
            border-color: #0079bf;
        }
        .loading {
            display: none;
            text-align: center;
            color: #666;
            padding: 20px;
        }
    </style>
    <script src="https://p.trellocdn.com/power-up.min.js"></script>
</head>
<body>
    <div class="manual-entry-popup">
        <div id="loadingState" class="loading">
            Loading card information...
        </div>
        
        <div id="entryForm" style="display: none;">
            <div class="card-info">
                <div class="card-name" id="cardName">Loading...</div>
                <div class="board-name" id="boardName">Board: Loading...</div>
            </div>
            
            <div class="success-message" id="successMessage"></div>
            <div class="error-message" id="errorMessage"></div>
            
            <form onsubmit="submitTimeEntry(event)">
                <div class="form-group">
                    <label>Time Duration</label>
                    <div class="preset-buttons">
                        <div class="preset-btn" onclick="setPresetTime(15)">15m</div>
                        <div class="preset-btn" onclick="setPresetTime(30)">30m</div>
                        <div class="preset-btn" onclick="setPresetTime(60)">1h</div>
                        <div class="preset-btn" onclick="setPresetTime(120)">2h</div>
                        <div class="preset-btn" onclick="setPresetTime(240)">4h</div>
                        <div class="preset-btn" onclick="setCustomTime()">Custom</div>
                    </div>
                    <div class="time-inputs">
                        <input type="number" id="hours" placeholder="Hours" min="0" max="24" value="1">
                        <input type="number" id="minutes" placeholder="Minutes" min="0" max="59" value="0">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="description">Description (optional)</label>
                    <textarea id="description" rows="3" placeholder="What did you work on?"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="entryDate">Date</label>
                    <input type="date" id="entryDate" required>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="billable" checked style="width: auto; margin-right: 8px;">
                        This time is billable
                    </label>
                </div>
                
                <button type="submit" class="btn" id="submitBtn">
                    ⏱️ Add Time Entry
                </button>
                
                <button type="button" class="btn secondary" onclick="closePopup()">
                    Cancel
                </button>
            </form>
        </div>
    </div>

    <script>
        const t = TrelloPowerUp.iframe();
        let cardData = {};
        let boardData = {};

        // Initialize when ready
        t.ready().then(() => {
            loadCardInfo();
            initializeForm();
        });

        async function loadCardInfo() {
            try {
                const card = await t.card('id', 'name');
                const board = await t.board('id', 'name');
                
                cardData = card;
                boardData = board;
                
                // Update UI
                document.getElementById('cardName').textContent = card.name;
                document.getElementById('boardName').textContent = `Board: ${board.name}`;
                
                // Show form
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('entryForm').style.display = 'block';
                
            } catch (error) {
                console.error('Error loading card info:', error);
                showError('Failed to load card information. Please try again.');
            }
        }

        function initializeForm() {
            // Set today's date as default
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('entryDate').value = today;
        }

        function setPresetTime(minutes) {
            // Clear all active states
            document.querySelectorAll('.preset-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Set active state
            event.target.classList.add('active');
            
            const hours = Math.floor(minutes / 60);
            const remainingMinutes = minutes % 60;
            
            document.getElementById('hours').value = hours;
            document.getElementById('minutes').value = remainingMinutes;
        }

        function setCustomTime() {
            // Clear all active states
            document.querySelectorAll('.preset-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Set active state
            event.target.classList.add('active');
            
            // Focus on hours input for custom entry
            document.getElementById('hours').focus();
        }

        async function submitTimeEntry(event) {
            event.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            const originalText = submitBtn.textContent;
            
            try {
                // Show loading state
                submitBtn.textContent = 'Adding...';
                submitBtn.disabled = true;
                
                // Get form data
                const hours = parseInt(document.getElementById('hours').value) || 0;
                const minutes = parseInt(document.getElementById('minutes').value) || 0;
                const totalMinutes = (hours * 60) + minutes;
                
                if (totalMinutes <= 0) {
                    throw new Error('Please enter a valid time duration');
                }
                
                const description = document.getElementById('description').value;
                const entryDate = document.getElementById('entryDate').value;
                const isBillable = document.getElementById('billable').checked;
                
                // Prepare data for API
                const entryData = {
                    card_id: cardData.id,
                    card_name: cardData.name,
                    board_id: boardData.id,
                    duration_minutes: totalMinutes,
                    description: description || `Manual entry for: ${cardData.name}`,
                    date: entryDate,
                    is_billable: isBillable
                };
                
                // Try to submit to TimeZZ API
                const success = await submitToAPI(entryData);
                
                if (success) {
                    showSuccess(`Added ${formatDuration(totalMinutes)} to "${cardData.name}"`);
                    
                    // Reset form
                    document.getElementById('hours').value = 1;
                    document.getElementById('minutes').value = 0;
                    document.getElementById('description').value = '';
                    
                    // Clear preset selection
                    document.querySelectorAll('.preset-btn').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    
                    // Auto-close after success (optional)
                    setTimeout(() => {
                        t.closePopup();
                    }, 2000);
                    
                } else {
                    // Fallback: save to Trello storage
                    await saveToTrelloStorage(entryData);
                    showSuccess(`Added ${formatDuration(totalMinutes)} (saved locally)`);
                    
                    setTimeout(() => {
                        t.closePopup();
                    }, 2000);
                }
                
            } catch (error) {
                console.error('Submit error:', error);
                showError(error.message || 'Failed to add time entry. Please try again.');
            } finally {
                // Reset button
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        }

        async function submitToAPI(entryData) {
            try {
                const authToken = await getAuthToken();
                
                const response = await fetch(`${getApiUrl()}/api/v1/time/entries/manual`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken || 'demo_token'}`
                    },
                    body: JSON.stringify(entryData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('Entry added successfully:', result);
                    return true;
                }
                
                console.error('API error:', response.status, response.statusText);
                return false;
                
            } catch (error) {
                console.error('API call failed:', error);
                return false;
            }
        }

        async function saveToTrelloStorage(entryData) {
            // Save to Trello as fallback
            const storageKey = `timezz_entries_${cardData.id}`;
            const existingEntries = await t.get('card', 'shared', storageKey) || [];
            
            const newEntry = {
                ...entryData,
                id: Date.now(),
                created_at: new Date().toISOString(),
                synced: false
            };
            
            existingEntries.push(newEntry);
            await t.set('card', 'shared', storageKey, existingEntries);
        }

        async function getAuthToken() {
            return await t.get('member', 'private', 'timezz_auth_token');
        }

        function getApiUrl() {
            return window.location.hostname === 'localhost' 
                ? 'http://localhost:8000' 
                : 'https://timezz-backend.onrender.com';
        }

        function formatDuration(minutes) {
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            
            if (hours > 0 && mins > 0) {
                return `${hours}h ${mins}m`;
            } else if (hours > 0) {
                return `${hours}h`;
            } else {
                return `${mins}m`;
            }
        }

        function showSuccess(message) {
            const successEl = document.getElementById('successMessage');
            successEl.textContent = message;
            successEl.style.display = 'block';
            
            const errorEl = document.getElementById('errorMessage');
            errorEl.style.display = 'none';
            
            // Hide after 3 seconds
            setTimeout(() => {
                successEl.style.display = 'none';
            }, 3000);
        }

        function showError(message) {
            const errorEl = document.getElementById('errorMessage');
            errorEl.textContent = message;
            errorEl.style.display = 'block';
            
            const successEl = document.getElementById('successMessage');
            successEl.style.display = 'none';
        }

        function closePopup() {
            t.closePopup();
        }

        // Handle time input changes
        document.getElementById('hours').addEventListener('input', clearPresetSelection);
        document.getElementById('minutes').addEventListener('input', clearPresetSelection);

        function clearPresetSelection() {
            document.querySelectorAll('.preset-btn').forEach(btn => {
                btn.classList.remove('active');
            });
        }
    </script>
</body>
</html>